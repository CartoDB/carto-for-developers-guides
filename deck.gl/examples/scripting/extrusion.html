<html>
  <head>
    <!-- FONT -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/deck.gl@^8.3.0/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/carto@^8.3.0/dist.min.js"></script>
    
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />

    <style type="text/css">
      body {
        margin: 0;
        padding: 0;
        font-family: 'Open Sans', Helvetica, sans-serif;
      }
      #map {
        width: 100vw;
        height: 100vh;
      }
      .layer-selector {
        position: absolute;
        z-index: 1;
        top: 0;
        right: 0;
        background-color: #fff;
        margin: 24px;
        padding: 10 24px;
        box-shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px;
        border-radius: 4px;
      }
      .layer-selector h3 {
        font-size: 16px;
        margin: 8px 0;
      }
      .layer-selector .input {
        display: flex;
        align-items: center;
        margin-top: 16px;
      }
      .layer-selector .input input {
        width: 16px;
        height: 16px;
        margin: 0 4px 0 0;
      }
      .layer-selector label,
      span {
        font-size: 14px;
      }
      .layer-selector .layout {
        display: table;
        width: 100%;
        margin-top: 8px;
      }
      .layer-selector .layout > * {
        display: table-cell;
        height: 12px;
      }
      .right-align {
        text-align: right;
      }
      .ctrl_select{
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1;
      }

      select {
        padding: 10px;
        font-size: 16px;
        color: #222;
        margin-right: 10px;
      }
    </style>
  </head>

  <body>
    <div class='ctrl_select'>
      <select id='industries'></select>
      <select id='indexes'></select>
    </div>

    <div id="map"></div>
  </body>

  <script type="text/javascript">
    deck.carto.setDefaultCredentials({
      username: "aasuero",
      apiKey: "Mdz_4y_BYrgocnBNnEhvEQ",
    });

    const industries = {
      ret: 'Total Retail',
      app: 'Total Apparel',
      acc: 'Accommodations',
      aut: 'Automotive Fuel',
      eap: 'Eating Places',
      gro: 'Grocery and Food Stores',
    };

    let selectIndustries = document.getElementById('industries');
    for(index in industries) {
      selectIndustries.options[selectIndustries.options.length] = new Option(industries[index], index);
    }

    let industry = 'ret';

    selectIndustries.addEventListener('change', () => {
      industry = selectIndustries.value;
      render();
    });

    const indexes = {
      txn_amt: 'Total Spend',
      txn_cnt: 'Total Transactions',
      acct_cnt: 'Total Accounts',
      avg_ticket: 'Average Ticket Size',
    };

    var selectIndexes = document.getElementById('indexes');
    for(index in indexes) {
      selectIndexes.options[selectIndexes.options.length] = new Option(indexes[index], index);
    }

    let currentIndex = 'txn_amt';

    selectIndexes.addEventListener('change', () => {
      currentIndex = selectIndexes.value;
      render();
    });

    // Colors for the breaks of the polygon layer
    const POLYGON_COLORS = {
      COLOR_1: [225, 83, 131],
      COLOR_2: [241, 109, 122],
      COLOR_3: [250, 138, 118],
      COLOR_4: [255, 166, 121],
      COLOR_5: [255, 194, 133],
      COLOR_6: [255, 221, 154],
      OTHER: [254, 246, 181],
    };

    const viewState = {
      latitude: 40.7368521,
      longitude: -73.9936065,
      zoom: 11,
      pitch: 60,
      bearing: 0,
      // dragRotate: true
    };

    // Create Deck.GL map
    const deckgl = new deck.DeckGL({
      container: "map",
      mapStyle: "https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",
      viewState,
      controller: true,
      getTooltip: ({ object }) => {
        if (!object)
          return false;
        const {geoid, index} = object.properties;

        return {
          html: `
            Geo ID: ${geoid} <br/>
            Index: ${index.toFixed(2)}
          `
        }
      },
      layers: []
    });

    render();

    // Function to render the layers. Will be invoked any time visibility changes.
    function render() {

      const sql = `SELECT geoid, the_geom_webmercator, avg(${currentIndex}) as index
            FROM aasuero.mrli_ny_jan WHERE industry ='${industry}'
            group by geoid, the_geom_webmercator`;

      console.log(sql);

      // update layers in deck.gl.
      const layers = [
        new deck.carto.CartoSQLLayer({
          id: "mrli",
          data: sql,
          getFillColor: (object) => {
            if (object.properties.index > 1000) {
              return POLYGON_COLORS.COLOR_1;
            } else if (object.properties.index > 500) {
              return POLYGON_COLORS.COLOR_2;
            } else if (object.properties.index > 300) {
              return POLYGON_COLORS.COLOR_3;
            } else if (object.properties.index > 100) {
              return POLYGON_COLORS.COLOR_4;
            } else if (object.properties.index > 50) {
              return POLYGON_COLORS.COLOR_5;
            } else if (object.properties.index > 25) {
              return POLYGON_COLORS.COLOR_6;
            } else {
              return POLYGON_COLORS.OTHER;
            }
          },
          getLineColor: [0, 0, 0, 0],
          lineWidthMinPixels: 0,
          pickable: true,
          filled: true,
          extruded: true,
          wireframe: true,
          getElevation: f => f.properties.index,
        }),
      ];

      deckgl.setProps({ layers });

      window.requestAnimationFrame(animate)
    }

    function animate() {
      viewState.bearing += 0.03;
      deckgl.setProps({ viewState: {...viewState} });
      window.requestAnimationFrame(animate)
    }
  </script>
</html>
