<!DOCTYPE html>
<html>
  
  <head>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://libs.cartocdn.com/mapbox-gl/v1.13.0/mapbox-gl.js"></script>
    <link href="https://libs.cartocdn.com/mapbox-gl/v1.13.0/mapbox-gl.css" rel="stylesheet" />
  </head>

  <body style="margin: 0; padding: 0;">
    <div id="map" style="position: absolute; top: 0; bottom: 0; width: 100%;"></div>
  </body>
  
  <script>

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
      center: [0, 0],
      zoom: 1
    });

    const REQUEST_GET_MAX_URL_LENGTH = 2048;

    addCartoLayer();

    async function addCartoLayer() {
      const tileSourceURLs = await getTileSources();
      map.addLayer(
        {
          id: 'populated_places',
          type: 'circle',
          source: {
            type: 'vector',
            tiles: tileSourceURLs
          },
          'source-layer': 'layer0',
          paint: {
            'circle-color': '#EE4D5A',
            'circle-stroke-color': '#FFF',
            'circle-stroke-width': 1
          }
        }
      );
    }

    async function getTileSources() {
      const mapConfig = JSON.stringify({
        version: '1.3.1',
        buffersize: {mvt: 1},
        layers: [
          {
            type: 'mapnik',
            options: {
              sql: 'SELECT the_geom_webmercator, name FROM populated_places',
              vector_extent: 4096,
              bufferSize: 1,
              version: '1.3.1'
            }
          }
        ]
      });
      const url = `https://public.carto.com/api/v1/map?apikey=default_public}`;
      const getUrl = `${url}&config=${encodeURIComponent(mapConfig)}`;
      let request;

      if (getUrl.length < REQUEST_GET_MAX_URL_LENGTH) {
        request = new Request(getUrl, {
          method: 'GET',
          headers: {
            Accept: 'application/json'
          }
        });

      } else {
        request = new Request(url, {
          method: 'POST',
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json'
          },
          body: mapConfig
        });
      }

      const response = await fetch(request);
      return (await response.json()).metadata.tilejson.vector.tiles
    }

  </script>

</html>
